window.VULCA_ANALYSIS={cache:{similarityMatrix:null,artworkProfiles:null},init(){if(window.VULCA_DATA)try{this.cache.similarityMatrix=this.buildSimilarityMatrix(),this.cache.artworkProfiles=this.buildArtworkProfiles(),console.log("✓ Analysis module initialized"),console.log(`  - Similarity matrix: ${Object.keys(this.cache.similarityMatrix).length} personas`),console.log(`  - Artwork profiles: ${Object.keys(this.cache.artworkProfiles).length} artworks`)}catch(i){console.error("❌ Analysis initialization failed:",i)}else console.error("❌ VULCA_DATA not loaded. Cannot initialize analysis module.")},rpaitCosineSimilarity(i,r){const t=[i.R,i.P,i.A,i.I,i.T],o=[r.R,r.P,r.A,r.I,r.T],e=t.reduce((i,r,t)=>i+r*o[t],0),a=Math.sqrt(t.reduce((i,r)=>i+r*r,0)),n=Math.sqrt(o.reduce((i,r)=>i+r*r,0));return 0===a||0===n?0:e/(a*n)},getPersonaAverageRPAIT(i){const r=window.VULCA_DATA.personas.find(r=>r.id===i);if(!r)return console.warn(`⚠ Persona not found: ${i}`),null;if(r.rpait)return r.rpait;const t=window.VULCA_DATA.critiques.filter(r=>r.personaId===i);if(0===t.length)return console.warn(`⚠ No critiques found for persona: ${i}`),null;const o={R:0,P:0,A:0,I:0,T:0};t.forEach(i=>{o.R+=i.rpait.R,o.P+=i.rpait.P,o.A+=i.rpait.A,o.I+=i.rpait.I,o.T+=i.rpait.T});const e=t.length;return{R:Math.round(o.R/e),P:Math.round(o.P/e),A:Math.round(o.A/e),I:Math.round(o.I/e),T:Math.round(o.T/e)}},getArtworkRPAITProfile(i){const r=window.VULCA_DATA.critiques.filter(r=>r.artworkId===i);if(0===r.length)return console.warn(`⚠ No critiques found for artwork: ${i}`),null;const t={R:0,P:0,A:0,I:0,T:0};r.forEach(i=>{t.R+=i.rpait.R,t.P+=i.rpait.P,t.A+=i.rpait.A,t.I+=i.rpait.I,t.T+=i.rpait.T});const o=r.length;return{R:(t.R/o).toFixed(1),P:(t.P/o).toFixed(1),A:(t.A/o).toFixed(1),I:(t.I/o).toFixed(1),T:(t.T/o).toFixed(1)}},getPersonaArtworkRPAIT(i,r){const t=window.VULCA_DATA.critiques.find(t=>t.personaId===i&&t.artworkId===r);return t?t.rpait:(console.warn(`⚠ No critique found for ${i} → ${r}`),null)},buildSimilarityMatrix(){const i={},r=window.VULCA_DATA.personas;return r.forEach(t=>{i[t.id]={},r.forEach(r=>{const o=this.getPersonaAverageRPAIT(t.id),e=this.getPersonaAverageRPAIT(r.id);i[t.id][r.id]=o&&e?this.rpaitCosineSimilarity(o,e):0})}),i},buildArtworkProfiles(){const i={};return window.VULCA_DATA.artworks.forEach(r=>{i[r.id]=this.getArtworkRPAITProfile(r.id)}),i},getSimilarityMatrix(){return this.cache.similarityMatrix||(this.cache.similarityMatrix=this.buildSimilarityMatrix()),this.cache.similarityMatrix},getArtworkProfiles(){return this.cache.artworkProfiles||(this.cache.artworkProfiles=this.buildArtworkProfiles()),this.cache.artworkProfiles},rpaitDistance(i,r){return 1-this.rpaitCosineSimilarity(i,r)},getPersonasSortedBySimilarity(i){const r=this.getSimilarityMatrix(),t=window.VULCA_DATA.personas;return r[i]?t.map(t=>({id:t.id,nameZh:t.nameZh,nameEn:t.nameEn,color:t.color,similarity:r[i][t.id]})).sort((i,r)=>r.similarity-i.similarity):(console.warn(`⚠ No similarity data for persona: ${i}`),[])}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.VULCA_ANALYSIS.init()}):window.VULCA_ANALYSIS.init();