!function(){"use strict";const e=/\[img:(img-\d+-\d+)\]/g;function i(i){if(!i||"string"!=typeof i)return console.warn("[Critique Parser] parseImageReferences called with invalid text"),[];const n=[];let t;for(e.lastIndex=0;null!==(t=e.exec(i));)n.push({index:n.length,imageId:t[1],startPos:t.index,endPos:t.index+t[0].length,fullMatch:t[0]});return console.log(`[Critique Parser] Found ${n.length} image reference(s) in text`),n}function n(e){const n=i(e);return[...new Set(n.map(e=>e.imageId))]}function t(e,n){const t=i(e);if(0===t.length)return{valid:[],invalid:[],references:[],allValid:!0};if(!window.ImageCompat)return console.error("[Critique Parser] ImageCompat utility not loaded"),{valid:[],invalid:t.map(e=>e.imageId),references:[],allValid:!1};const a=window.ImageCompat.getArtworkImages(n),r=new Set(a.map(e=>e.id)),s=[],l=[];t.forEach(e=>{r.has(e.imageId)?s.push(e):(l.push(e),console.warn(`[Critique Parser] Invalid image reference: ${e.imageId} not found in artwork ${n.id}`,`Position: ${e.startPos}-${e.endPos}`))});const o=0===l.length;return console.log(`[Critique Parser] Validation for ${n.id}: ${s.length} valid, ${l.length} invalid`),{valid:s,invalid:l,references:t,allValid:o}}window.CritiqueParser={parseImageReferences:i,extractImageIds:n,validateImageReferences:t,renderImageReferences:function(e,i,n={}){if(!e||"string"!=typeof e)return e||"";const a=t(e,i);if(0===a.references.length)return e;const r=window.ImageCompat.getArtworkImages(i),s=new Map(r.map(e=>[e.id,e])),l={linkClass:n.linkClass||"image-reference-link",targetBlank:n.targetBlank||!1,showImageTitle:!1!==n.showImageTitle,invalidClass:n.invalidClass||"image-reference-invalid",...n};let o=e,d=0;return a.references.forEach(e=>{if(a.valid.some(i=>i.index===e.index)){const n=s.get(e.imageId),t=(l.showImageTitle?n.titleZh||n.titleEn:e.imageId,n.sequence||"?"),a=`<a href="#" class="${l.linkClass}" data-image-id="${e.imageId}" data-artwork-id="${i.id}" onclick="event.preventDefault();" title="${n.titleEn}">图片${t}</a>`,r=e.startPos+d,c=e.endPos+d;o=o.substring(0,r)+a+o.substring(c),d+=a.length-e.fullMatch.length,console.log(`[Critique Parser] Replaced ${e.fullMatch} with link to ${e.imageId}`)}else if(l.invalidClass){const i=`<span class="${l.invalidClass}">${e.fullMatch}</span>`,n=e.startPos+d,t=e.endPos+d;o=o.substring(0,n)+i+o.substring(t),d+=i.length-e.fullMatch.length}}),o},getReferencedImages:function(e,i){const n=t(e,i),a=window.ImageCompat.getArtworkImages(i);return n.valid.map(e=>a.find(i=>i.id===e.imageId)).filter(e=>void 0!==e)},enrichCritiqueWithReferences:function(e,i){if(!e)return console.warn("[Critique Parser] enrichCritiqueWithReferences called with null critique"),e;const t=n(e.textZh||""),a=n(e.textEn||""),r=[...new Set([...t,...a])],s={valid:[],invalid:[]},l=window.ImageCompat?window.ImageCompat.getArtworkImages(i):[],o=new Set(l.map(e=>e.id));return r.forEach(e=>{o.has(e)?s.valid.push(e):(s.invalid.push(e),console.warn(`[Critique Parser] Invalid reference in critique: ${e}`))}),e.imageReferences=s.valid,console.log(`[Critique Parser] Enriched critique ${e.personaId} → ${e.artworkId}: ${s.valid.length} references`),e}},console.log("[Critique Parser] Utility initialized with functions:",Object.keys(window.CritiqueParser))}();