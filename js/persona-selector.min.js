window.PersonaSelection=function(){"use strict";let e=["su-shi","guo-xi","john-ruskin"],n=e.slice();function o(o){if(!Array.isArray(o))return console.error("PersonaSelection: personaIds must be an array"),!1;if(!window.VULCA_DATA||!window.VULCA_DATA.personas)return console.error("PersonaSelection: VULCA_DATA.personas not available"),!1;const t=window.VULCA_DATA.personas.map(e=>e.id),s=o.filter(e=>!t.includes(e));return s.length>0?(console.error("PersonaSelection: Invalid persona IDs:",s),!1):(n=e.slice(),e=o.slice(),function(){try{sessionStorage.setItem("vulca-persona-selection",JSON.stringify(e))}catch(e){console.warn("PersonaSelection: sessionStorage unavailable",e)}}(),function(){const n=new CustomEvent("persona:selectionChanged",{detail:{personas:e.slice(),count:e.length},bubbles:!0});window.dispatchEvent(n),console.log("✓ Emitted persona:selectionChanged event:",{personas:e,count:e.length})}(),console.log("✓ Persona selection updated:",e),!0)}function t(){(function(){try{const n=sessionStorage.getItem("vulca-persona-selection");if(n){const o=JSON.parse(n);if(Array.isArray(o)&&o.length>0&&window.VULCA_DATA&&window.VULCA_DATA.personas){const n=window.VULCA_DATA.personas.map(e=>e.id);if(o.every(e=>n.includes(e)))return e=o,console.log("✓ Restored persona selection from sessionStorage:",e),!0}}}catch(e){console.warn("PersonaSelection: Failed to restore from sessionStorage",e)}return!1})()||console.log("✓ Persona selection initialized with defaults:",e),function(){const n=document.getElementById("persona-badges-container");if(!n)return void console.error("PersonaSelection: badges container not found");if(!window.VULCA_DATA||!window.VULCA_DATA.personas)return void console.error("PersonaSelection: VULCA_DATA.personas not available");const t=window.VULCA_DATA.personas;Array.isArray(t)&&0!==t.length?(n.innerHTML="",t.forEach(t=>{if(!t.id||!t.nameZh||!t.nameEn)return void console.warn("PersonaSelection: skipping invalid persona",t);const i=function(n){const t=document.createElement("button");t.className="persona-badge",t.dataset.persona=n.id,t.setAttribute("aria-pressed","false"),t.setAttribute("aria-label",`${n.nameZh} ${n.nameEn}`);const i=document.createElement("span");i.className="badge-name",i.textContent=n.nameZh;const l=document.createElement("span");l.className="badge-name-en",l.textContent=n.nameEn,t.appendChild(i),t.appendChild(l);let c=null,d=0,u=null;return t.addEventListener("click",i=>{const l=Date.now();l-d<300&&u===t?(clearTimeout(c),function(n){if(e.includes(n)){const t=e.filter(e=>e!==n);console.log(`Double click: ${n}, deselecting. New selection:`,t),o(t)&&(a(),r(t.length))}else s(n)}(n.id),d=0,u=null):(clearTimeout(c),c=setTimeout(()=>{s(n.id)},300),d=l,u=t)}),t}(t);n.appendChild(i)}),console.log(`✓ Rendered ${t.length} persona badges`)):console.warn("PersonaSelection: personas array is empty")}(),a(),console.log("✓ UI handlers initialized")}function s(n,t){let s;s=e.includes(n)?e.filter(e=>e!==n):[...e,n],console.log(`Single click: ${n}, new selection:`,s),o(s)&&(a(),r(s.length))}function a(){document.querySelectorAll(".persona-badge").forEach(n=>{const o=n.dataset.persona;e.includes(o)?(n.classList.add("active"),n.setAttribute("aria-pressed","true")):(n.classList.remove("active"),n.setAttribute("aria-pressed","false"))}),console.log("✓ Badges synced with state:",e)}function r(e){const n=document.getElementById("persona-count");n&&(n.textContent=`已选择 ${e} 位评论家`)}return"loading"===document.readyState?document.addEventListener("DOMContentLoaded",t):t(),{setSelection:o,getSelection:function(){return e.slice()}}}(),console.log("✓ Persona selection state manager loaded");