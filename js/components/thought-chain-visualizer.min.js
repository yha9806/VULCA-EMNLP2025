class ThoughtChainVisualizer{constructor(e,t,s={}){if(!e||!e.messages)throw new Error("[ThoughtChainVisualizer] Invalid dialogue thread provided");if(!t)throw new Error("[ThoughtChainVisualizer] Container element required");this.thread=e,this.container=t,this.options={showConnectionLines:!0,animateLines:!0,enableHoverPreviews:!0,...s},this.svgOverlay=null,this.connectionLines=new Map,this.messageElements=new Map,this.interactionColors={initial:"#6366f1","agree-extend":"#22c55e","question-challenge":"#eab308",synthesize:"#8b5cf6",counter:"#ef4444",reflect:"#3b82f6"},console.log("[ThoughtChainVisualizer] Initialized",{threadId:this.thread.id,messageCount:this.thread.messages.length,options:this.options}),this._initializeSVGOverlay()}_initializeSVGOverlay(){this.svgOverlay=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svgOverlay.setAttribute("class","thought-chain-svg-overlay"),this.svgOverlay.setAttribute("width","100%"),this.svgOverlay.setAttribute("height","100%"),this.svgOverlay.style.position="absolute",this.svgOverlay.style.top="0",this.svgOverlay.style.left="0",this.svgOverlay.style.pointerEvents="none",this.svgOverlay.style.zIndex="1";const e=document.createElementNS("http://www.w3.org/2000/svg","defs");Object.entries(this.interactionColors).forEach(([t,s])=>{const i=document.createElementNS("http://www.w3.org/2000/svg","marker");i.setAttribute("id",`arrow-${t}`),i.setAttribute("viewBox","0 0 10 10"),i.setAttribute("refX","8"),i.setAttribute("refY","5"),i.setAttribute("markerWidth","6"),i.setAttribute("markerHeight","6"),i.setAttribute("orient","auto-start-reverse");const n=document.createElementNS("http://www.w3.org/2000/svg","path");n.setAttribute("d","M 0 0 L 10 5 L 0 10 z"),n.setAttribute("fill",s),i.appendChild(n),e.appendChild(i)}),this.svgOverlay.appendChild(e),this.container.style.position="relative",this.container.insertBefore(this.svgOverlay,this.container.firstChild),console.log("[ThoughtChainVisualizer] SVG overlay created")}getColorForType(e){return this.interactionColors[e]||"#9ca3af"}registerMessageElement(e,t){this.messageElements.set(e,t),console.log("[ThoughtChainVisualizer] Registered message element:",e)}drawConnectionLine(e,t,s){if(!this.options.showConnectionLines)return;const i=this.messageElements.get(e),n=this.messageElements.get(t);if(!i||!n)return void console.warn("[ThoughtChainVisualizer] Cannot draw line: element not found",{fromMessageId:e,toMessageId:t});const o=this.container.getBoundingClientRect(),r=i.getBoundingClientRect(),a=n.getBoundingClientRect(),l=r.left-o.left+r.width/2,h=r.bottom-o.top,c=a.left-o.left+a.width/2,d=a.top-o.top,g=(l+c)/2,u=(h+d)/2,v=document.createElementNS("http://www.w3.org/2000/svg","path");if(v.setAttribute("d",`M ${l},${h} Q ${g},${u} ${c},${d}`),v.setAttribute("class",`connection-line connection-line-${s}`),v.setAttribute("stroke",this.getColorForType(s)),v.setAttribute("stroke-width","2"),v.setAttribute("fill","none"),v.setAttribute("marker-end",`url(#arrow-${s})`),v.setAttribute("data-from",e),v.setAttribute("data-to",t),v.setAttribute("data-interaction",s),this.options.animateLines){const e=v.getTotalLength();v.style.strokeDasharray=e,v.style.strokeDashoffset=e,v.style.transition="stroke-dashoffset 1s ease-in-out"}this.options.enableHoverPreviews&&(v.style.pointerEvents="stroke",v.style.cursor="pointer",v.addEventListener("mouseenter",e=>{this._showLinePreview(t,e),v.style.strokeWidth="3",v.style.opacity="1"}),v.addEventListener("mouseleave",()=>{this._hideLinePreview(),v.style.strokeWidth="2",v.style.opacity="0.6"}),v.addEventListener("click",()=>{this._scrollToMessage(t)})),this.svgOverlay.appendChild(v),this.connectionLines.set(t,v),this.options.animateLines&&setTimeout(()=>{v.style.strokeDashoffset="0"},100),console.log("[ThoughtChainVisualizer] Drew connection line",{from:e,to:t,interactionType:s})}drawAllConnections(){this.thread.messages.forEach(e=>{if(e.replyTo){const t=this.thread.messages.find(t=>t.personaId===e.replyTo);t&&this.drawConnectionLine(t.id,e.id,e.interactionType)}}),console.log("[ThoughtChainVisualizer] Drew all connections")}updateConnectionPositions(){this.connectionLines.forEach((e,t)=>{const s=e.getAttribute("data-from"),i=e.getAttribute("data-interaction");e.remove(),this.connectionLines.delete(t),this.drawConnectionLine(s,t,i)}),console.log("[ThoughtChainVisualizer] Updated connection positions")}_showLinePreview(e,t){const s=this.thread.messages.find(t=>t.id===e);if(!s)return;const i=document.documentElement.getAttribute("data-lang")||"zh",n=window.VULCA_DATA.personas.find(e=>e.id===s.personaId),o="en"===i?s.textEn:s.textZh,r=o.substring(0,100)+(o.length>100?"...":"");let a=document.querySelector(".thought-chain-tooltip");a||(a=document.createElement("div"),a.className="thought-chain-tooltip",document.body.appendChild(a)),a.innerHTML=`\n      <div class="tooltip-author" style="color: ${n.color}">\n        ${"en"===i?n.nameEn:n.nameZh}\n      </div>\n      <div class="tooltip-snippet">${r}</div>\n    `,a.style.display="block",a.style.left=`${t.pageX+10}px`,a.style.top=`${t.pageY+10}px`}_hideLinePreview(){const e=document.querySelector(".thought-chain-tooltip");e&&(e.style.display="none")}_scrollToMessage(e){const t=this.messageElements.get(e);t&&(t.scrollIntoView({behavior:"smooth",block:"center"}),t.style.boxShadow="0 0 20px rgba(102, 126, 234, 0.5)",setTimeout(()=>{t.style.boxShadow=""},2e3))}clearConnections(){this.connectionLines.forEach(e=>e.remove()),this.connectionLines.clear(),console.log("[ThoughtChainVisualizer] Cleared all connections")}destroy(){this.clearConnections(),this.svgOverlay&&this.svgOverlay.remove(),this.messageElements.clear(),console.log("[ThoughtChainVisualizer] Destroyed")}}"undefined"!=typeof module&&module.exports&&(module.exports=ThoughtChainVisualizer);