const THOUGHT_CHAINS={"su-shi":{zh:["è§‚å¯Ÿä½œå“çš„å½¢å¼ä¸æ„å¢ƒ...","å›å¿†å¤ä»£ä¹¦ç”»ç†è®º...","æ€è€ƒè‡ªç„¶ä¸æŠ€è‰ºçš„å…³ç³»...","æ„æ€ä»¥ä¼ ç»Ÿè§†è§’è®ºä¹‹..."],en:["Observing form and artistic conception...","Recalling ancient painting theories...","Contemplating nature and craftsmanship...","Framing a traditional perspective..."]},"guo-xi":{zh:["åˆ†æç¬”è§¦çš„éŸµå¾‹æ„Ÿ...","æ€è€ƒå±±æ°´ç”»çš„ç²¾ç¥æœ¬è´¨...","å¯»æ‰¾è‡ªç„¶ä¸æŠ€æœ¯çš„è”ç³»...","é…é…¿å±±æ—ä¹‹æ°”çš„è¡¨è¾¾..."],en:["Analyzing the rhythm of brushwork...","Pondering the essence of landscape painting...","Finding connections between nature and technique...","Brewing the expression of mountain spirit..."]},"john-ruskin":{zh:["å®¡è§†é“å¾·æ„ä¹‰...","æ€è€ƒç¥åœ£ç§©åº...","è¯„ä¼°è‰ºæœ¯çš„çœŸå®æ€§...","æ„å»ºæ‰¹åˆ¤æ€§è®ºç‚¹..."],en:["Examining moral implications...","Considering the divine order...","Evaluating artistic authenticity...","Constructing critical arguments..."]},default:{zh:["åˆ†æä½œå“ç‰¹å¾...","å›é¡¾ç›¸å…³ç†è®º...","æ€è€ƒæ·±å±‚å«ä¹‰...","ç»„ç»‡è¯„è®ºæ€è·¯..."],en:["Analyzing artwork features...","Reviewing relevant theories...","Contemplating deeper meanings...","Organizing critical thoughts..."]}};class DialoguePlayer{constructor(e,t,s={}){if(!(t&&t instanceof HTMLElement))throw new Error("[DialoguePlayer] Invalid container element provided");if(this.container=t,this.state="loading",!e){const e=new Error("[DialoguePlayer] No dialogue thread data provided");throw this._showErrorState(e.message),e}if(!e.messages||!Array.isArray(e.messages)){const e=new Error("[DialoguePlayer] Thread.messages is missing or invalid (must be array)");throw this._showErrorState(e.message),e}if(0===e.messages.length)return console.warn("[DialoguePlayer] Thread has no messages, showing empty state"),void this._showEmptyState();e.participants&&0!==e.participants.length||console.warn("[DialoguePlayer] No participants data, using fallback"),this.thread=e,this.state="success",this.options={speed:s.speed||1,autoPlay:s.autoPlay||!1,lang:s.lang||"zh"},this.currentTime=0,this.speed=this.options.speed,this.isPlaying=!1,this.isPaused=!1,this.lastFrameTime=0,this.rafId=null,this.renderedMessages=new Set,this.messageElements=new Map,this._currentMessageEl=null,this.currentMessageIndex=-1,this.autoScrollDisabled=!1,this._isAutoScrolling=!1,this._thoughtChainIntervals=new Map,this._thoughtChainStates=new Map,this.totalDuration=this._calculateTotalDuration(),this._initializeUI(),this.thoughtChainVisualizer=null,"undefined"!=typeof ThoughtChainVisualizer&&(this.thoughtChainVisualizer=new ThoughtChainVisualizer(this.thread,this.messagesContainer,{showConnectionLines:!1!==s.showConnectionLines,animateLines:!1!==s.animateLines,enableHoverPreviews:!1!==s.enableHoverPreviews}),console.log("[DialoguePlayer] ThoughtChainVisualizer initialized")),console.log(`[DialoguePlayer] Initialized for thread: ${this.thread.id}`),console.log(`[DialoguePlayer] Messages: ${this.thread.messages.length}, Duration: ${this.totalDuration}ms`),requestAnimationFrame(()=>{this._startNaturalPlayback()})}_calculateTotalDuration(){return this.thread.messages&&0!==this.thread.messages.length?Math.max(...this.thread.messages.map(e=>e.timestamp))+3e3:0}_randomDelay(e,t){return Math.floor(Math.random()*(t-e+1))+e}_calculateNaturalDelay(e,t){let s=this._randomDelay(4e3,7e3);const a="en"===(document.documentElement.getAttribute("data-lang")||"zh")?e.textEn:e.textZh;return s+=500*Math.floor(a.length/100),0===t&&(s=Math.floor(.8*s)),s=Math.min(s,12e3),console.log(`[DialoguePlayer] Message ${t} delay: ${s}ms (length: ${a.length} chars)`),s}_revealMessage(e){const t=this.thread.messages.findIndex(t=>t.id===e);if(-1===t)return void console.error(`[DialoguePlayer] Message not found in thread: ${e}`);const s=this.thread.messages[t];let a=this.messageElements.get(e);if(!a){if(console.log(`[DialoguePlayer] Creating message ${t+1} dynamically...`),a=this._createMessageElement(s,t),!a)return;if(t>0){a.classList.add("future");const e=this._createThoughtChain(s.personaId);a.appendChild(e),this._startThoughtChainCarousel(s.id,e,s.personaId)}if(this.messagesContainer.appendChild(a),this.messageElements.set(s.id,a),this.renderedMessages.add(s.id),console.log(`[DialoguePlayer] Message ${t+1} DOM created with thought chain`),t>0){const t=3e3+1e3*Math.random();return void setTimeout(()=>{this._revealMessageContent(e)},t)}}this._currentMessageEl&&(this._currentMessageEl.classList.remove("current"),this._currentMessageEl.classList.add("past"),this._currentMessageEl.removeAttribute("aria-current"),console.log("[DialoguePlayer] Previous message transitioned to past")),a.classList.remove("message-hidden","future"),a.classList.add("current","message-appearing"),a.setAttribute("aria-current","true"),this._currentMessageEl=a,this.currentMessageIndex=t,console.log(`[DialoguePlayer] Message ${t+1}/${this.thread.messages.length} revealed as current`),this._markFutureMessages(),this.autoScrollDisabled||this._scrollToMessage(a)}_revealMessageContent(e){const t=this.messageElements.get(e);if(!t)return void console.warn(`[DialoguePlayer] Cannot reveal content - message element not found: ${e}`);const s=this.thread.messages.findIndex(t=>t.id===e);this._stopThoughtChainCarousel(e);const a=t.querySelector(".thought-chain");a&&(a.remove(),console.log(`[DialoguePlayer] Removed thought chain for ${e}`)),this._currentMessageEl&&(this._currentMessageEl.classList.remove("current"),this._currentMessageEl.classList.add("past"),this._currentMessageEl.removeAttribute("aria-current")),t.classList.remove("message-hidden","future"),t.classList.add("current","message-appearing"),t.setAttribute("aria-current","true"),this._currentMessageEl=t,this.currentMessageIndex=s,console.log(`[DialoguePlayer] Message ${s+1} content revealed`),this._markFutureMessages(),this.autoScrollDisabled||this._scrollToMessage(t)}_startNaturalPlayback(){console.log("[DialoguePlayer] Starting natural playback..."),this._playbackTimeouts=[];let e=0;this.thread.messages.forEach((t,s)=>{const a=this._calculateNaturalDelay(t,s);e+=a;const n=setTimeout(()=>{this._revealMessage(t.id)},e);this._playbackTimeouts.push(n)}),console.log(`[DialoguePlayer] Scheduled ${this.thread.messages.length} messages, total duration: ${e}ms`)}_renderAllMessages(){console.log("[DialoguePlayer] Rendering initial message only (natural dialogue mode)...");const e=[...this.thread.messages].sort((e,t)=>e.timestamp-t.timestamp);if(e.length>0){const t=e[0],s=this._createMessageElement(t,0);s.classList.add("message-hidden"),this.messagesContainer.appendChild(s),this.messageElements.set(t.id,s),this.renderedMessages.add(t.id),console.log(`[DialoguePlayer] Rendered first message: ${t.id}`)}console.log(`[DialoguePlayer] Initial render complete (1 of ${this.thread.messages.length} messages)`),this.thoughtChainVisualizer&&(this.thread.messages.forEach(e=>{const t=this.messageElements.get(e.id);t&&this.thoughtChainVisualizer.registerMessageElement(e.id,t)}),setTimeout(()=>{this.thread.messages.forEach(e=>{if(e.replyTo){const t=this.thread.messages.find(t=>t.personaId===e.replyTo);t&&this.thoughtChainVisualizer.drawConnectionLine(t.id,e.id,e.interactionType)}}),console.log("[DialoguePlayer] Drew all connection lines")},100))}_initializeUI(){this.container.classList.add("dialogue-player"),this.container.innerHTML="";let e=this.thread.topic,t=this.thread.topicEn;if(window.VULCA_DATA&&this.thread.artworkId){const s=window.VULCA_DATA.artworks?.find(e=>e.id===this.thread.artworkId);s&&(e=s.titleZh||e,t=s.titleEn||t)}const s=document.createElement("div");s.className="dialogue-player__header",s.innerHTML=`\n      <h3 class="dialogue-player__topic">\n        <span class="dialogue-player__topic-zh">${e}</span>\n        <span class="dialogue-player__topic-en">${t}</span>\n      </h3>\n      <div class="dialogue-player__participants">\n        ${this.thread.participants.map(e=>{const t=window.VULCA_DATA.personas.find(t=>t.id===e);return`<span class="dialogue-player__participant" data-persona="${e}">${t?t.nameZh:e}</span>`}).join(" Â· ")}\n      </div>\n    `,this.container.appendChild(s),this.messagesContainer=document.createElement("div"),this.messagesContainer.className="dialogue-player__messages",this.container.appendChild(this.messagesContainer),this._renderAllMessages(),this.controlsContainer=document.createElement("div"),this.controlsContainer.className="dialogue-player__controls",this.container.appendChild(this.controlsContainer),this._initializeControls(),this._setupResponsiveMode(),this._setupTouchGestures(),console.log("[DialoguePlayer] UI structure initialized")}_setupResponsiveMode(){const e=()=>{window.innerWidth<=480?this.container.classList.add("compact-mode"):this.container.classList.remove("compact-mode")};e(),window.addEventListener("resize",e),console.log("[DialoguePlayer] Responsive mode enabled")}_setupTouchGestures(){let e=0,t=0;this.messagesContainer.addEventListener("touchstart",s=>{e=s.touches[0].clientX,t=this.currentTime},{passive:!0}),this.messagesContainer.addEventListener("touchmove",t=>{const s=t.touches[0].clientX-e;Math.abs(s)>50&&(this.messagesContainer.style.transform=`translateX(${.1*s}px)`)},{passive:!0}),this.messagesContainer.addEventListener("touchend",t=>{const s=t.changedTouches[0].clientX-e;this.messagesContainer.style.transform="",this.messagesContainer.style.transition="transform 0.3s ease",setTimeout(()=>{this.messagesContainer.style.transition=""},300),Math.abs(s)>50&&(s>0?(this.seek(Math.max(0,this.currentTime-2e3)),console.log("[DialoguePlayer] Swipe right: rewind")):(this.seek(Math.min(this.totalDuration,this.currentTime+2e3)),console.log("[DialoguePlayer] Swipe left: forward")))},{passive:!0}),console.log("[DialoguePlayer] Touch gestures enabled")}play(){this.isPlaying?console.log("[DialoguePlayer] Already playing"):(this.isPlaying=!0,this.isPaused=!1,this.lastFrameTime=performance.now(),console.log(`[DialoguePlayer] Starting playback from ${this.currentTime}ms at ${this.speed}x speed`),this._animate())}pause(){this.isPlaying?(this.isPlaying=!1,this.isPaused=!0,this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null),console.log(`[DialoguePlayer] Paused at ${this.currentTime}ms`)):console.log("[DialoguePlayer] Not currently playing")}resume(){this.isPaused?this.play():console.log("[DialoguePlayer] Not currently paused")}setSpeed(e){e<=0?console.warn("[DialoguePlayer] Speed must be positive, ignoring"):(this.speed=e,console.log(`[DialoguePlayer] Speed set to ${this.speed}x`))}scrubTo(e){const t=Math.max(0,Math.min(e,this.totalDuration));this.currentTime=t,this.renderedMessages.clear(),this.messagesContainer.innerHTML="",this._renderMessagesUpToTime(this.currentTime),console.log(`[DialoguePlayer] Scrubbed to ${this.currentTime}ms`)}reset(){this.pause(),this.currentTime=0,this.renderedMessages.clear(),this.messagesContainer.innerHTML="",console.log("[DialoguePlayer] Reset to beginning")}_animate(){if(!this.isPlaying)return;const e=performance.now(),t=e-this.lastFrameTime;if(this.currentTime+=t*this.speed,this.currentTime>=this.totalDuration)return this.currentTime=this.totalDuration,this.pause(),void console.log(`[DialoguePlayer] Playback completed at ${this.currentTime}ms`);this._checkTimeline(this.currentTime),this.lastFrameTime=e,this.rafId=requestAnimationFrame(()=>this._animate())}_checkTimeline(e){this.thread.messages.forEach(t=>{t.timestamp<=e&&!this.renderedMessages.has(t.id)&&(console.log(`[DialoguePlayer] Rendering message at ${t.timestamp}ms: ${t.id}`),this._renderMessage(t),this.renderedMessages.add(t.id))})}_renderMessagesUpToTime(e){const t=this.thread.messages.filter(t=>t.timestamp<=e).sort((e,t)=>e.timestamp-t.timestamp);console.log(`[DialoguePlayer] Rendering ${t.length} messages up to ${e}ms`),t.forEach(e=>{this.renderedMessages.has(e.id)||(this._renderMessage(e),this.renderedMessages.add(e.id))})}_renderMessage(e){const t=this._getPersona(e.personaId);if(!t)return void console.warn(`[DialoguePlayer] Persona not found: ${e.personaId}`);const s=document.documentElement.getAttribute("data-lang")||this.options.lang,a=document.createElement("div");if(a.className="dialogue-message",a.dataset.messageId=e.id,a.dataset.personaId=e.personaId,a.dataset.interactionType=e.interactionType,a.setAttribute("role","article"),a.setAttribute("aria-label",`Comment by ${t.nameZh} ${t.nameEn}`),a.innerHTML=`\n      <div class="message-header">\n        <span class="message-author" style="color: ${t.color}">\n          ${"en"===s?t.nameEn:t.nameZh}\n        </span>\n        <span class="interaction-badge ${e.interactionType}">\n          ${this._getInteractionLabel(e.interactionType,s)}\n        </span>\n      </div>\n      <div class="message-content">\n        ${"en"===s?e.textEn:e.textZh}\n      </div>\n    `,console.log(`[DialoguePlayer] _renderMessage ${e.id}: quotedText=${!!e.quotedText}, replyTo=${e.replyTo}`),e.quotedText&&e.replyTo){console.log(`[DialoguePlayer] _renderMessage: Rendering quote ref for ${e.id}`);const t=this._renderQuoteRef(e),s=a.querySelector(".message-content");s&&t&&(s.insertBefore(t,s.firstChild),console.log(`[DialoguePlayer] _renderMessage: Quote ref inserted for ${e.id}`))}if(e.references&&e.references.length>0){console.log(`[DialoguePlayer] _renderMessage: Rendering ${e.references.length} KB references for ${e.id}`);const s=this._renderKnowledgeReferences(e,t);s&&(a.appendChild(s),console.log(`[DialoguePlayer] _renderMessage: KB references added for ${e.id}`))}const n=a.querySelector(".interaction-badge");if(n&&e.replyTo?(n.classList.add("clickable"),n.style.cursor="pointer",n.setAttribute("title",this._getInteractionTooltip(e.interactionType,s)),n.addEventListener("click",t=>{t.stopPropagation(),this._scrollToPersonaMessage(e.replyTo)})):n&&n.setAttribute("title",this._getInteractionTooltip(e.interactionType,s)),a.classList.add("appearing"),this.messagesContainer.appendChild(a),this.messageElements.set(e.id,a),this.thoughtChainVisualizer&&(this.thoughtChainVisualizer.registerMessageElement(e.id,a),e.replyTo)){const t=this.thread.messages.find(t=>t.personaId===e.replyTo);t&&this.renderedMessages.has(t.id)&&setTimeout(()=>{this.thoughtChainVisualizer.drawConnectionLine(t.id,e.id,e.interactionType)},100)}requestAnimationFrame(()=>{a.classList.remove("appearing"),a.classList.add("visible")}),a.scrollIntoView({behavior:"smooth",block:"nearest"}),console.log(`[DialoguePlayer] Rendered message: ${e.id} (${t.nameZh})`)}_getPersona(e){return window.VULCA_DATA.personas.find(t=>t.id===e)||null}_getInteractionLabel(e,t){return window.INTERACTION_TYPES&&window.INTERACTION_TYPES[e]?"en"===t?window.INTERACTION_TYPES[e].labelEn:window.INTERACTION_TYPES[e].labelZh:e}_getInteractionTooltip(e,t){const s={initial:{zh:"å¼€å¯è¯é¢˜ï¼šé¦–æ¬¡å¯¹ä½œå“å‘è¡¨è§‚ç‚¹",en:"Initial: First perspective on the artwork"},"agree-extend":{zh:"èµåŒå¹¶å»¶ä¼¸ï¼šè®¤åŒå‰äººè§‚ç‚¹ï¼Œè¿›ä¸€æ­¥æ‹“å±•",en:"Agrees & Extends: Builds upon previous perspective"},"question-challenge":{zh:"è´¨ç–‘ï¼šå¯¹å‰äººè§‚ç‚¹æå‡ºç–‘é—®æˆ–æŒ‘æˆ˜",en:"Questions: Challenges previous perspective"},synthesize:{zh:"ç»¼åˆï¼šæ•´åˆå¤šæ–¹è§‚ç‚¹ï¼Œå½¢æˆæ–°è§è§£",en:"Synthesizes: Integrates multiple perspectives"},counter:{zh:"åé©³ï¼šæ˜ç¡®åå¯¹å‰äººè§‚ç‚¹ï¼Œæå‡ºç›¸åçœ‹æ³•",en:"Counters: Directly opposes previous perspective"},reflect:{zh:"åæ€ï¼šåŸºäºå¯¹è¯å›é¡¾è‡ªèº«è§‚ç‚¹",en:"Reflects: Reconsiders own perspective based on dialogue"}};return s[e]?s[e][t]:e}_renderQuoteRef(e){const t=document.documentElement.getAttribute("data-lang")||this.options.lang,s=this._getPersona(e.replyTo);if(!s)return console.warn(`[DialoguePlayer] Referenced persona not found: ${e.replyTo}`),document.createElement("div");const a=document.createElement("div");a.className="quote-ref",a.dataset.quoteId=e.id,a.dataset.replyTo=e.replyTo;const n="en"===t?"Reply to":"å›å¤",i="en"===t?s.nameEn:s.nameZh;return a.innerHTML=`\n      <span class="quote-ref-icon">â†©</span>\n      <span class="quote-ref-label">${n}</span>\n      <span class="quote-ref-author" style="color: ${s.color}">${i}</span>\n      <div class="quote-ref-tooltip">\n        <cite style="color: ${s.color}">${i}</cite>\n        <p>${e.quotedText}</p>\n      </div>\n    `,a.style.cursor="pointer",a.setAttribute("title","en"===t?"Click to view original message":"ç‚¹å‡»æŸ¥çœ‹åŸå§‹æ¶ˆæ¯"),a.addEventListener("click",t=>{t.stopPropagation(),window.innerWidth<=768||"ontouchstart"in window?this._showQuoteModal(e,s):this._scrollToPersonaMessage(e.replyTo)}),console.log(`[DialoguePlayer] Rendered quote reference for message ${e.id} â†’ ${e.replyTo}`),a}_renderKnowledgeReferences(e,t){const s=document.documentElement.getAttribute("data-lang")||this.options.lang,a=document.createElement("div");a.className="message-references",a.style.setProperty("--persona-color",t.color);const n=document.createElement("button");n.className="reference-badge",n.setAttribute("aria-expanded","false"),n.setAttribute("aria-label","en"===s?`${e.references.length} knowledge base references. Click to expand.`:`${e.references.length}ä¸ªçŸ¥è¯†åº“å¼•ç”¨ã€‚ç‚¹å‡»å±•å¼€ã€‚`),n.innerHTML=`\n      <span class="badge-icon">ğŸ“š</span>\n      <span class="badge-count">${e.references.length}</span>\n      <span class="badge-label" data-lang="zh">ä¸ªå¼•ç”¨</span>\n      <span class="badge-label" data-lang="en">references</span>\n    `;const i=document.createElement("div");return i.className="reference-list",i.setAttribute("role","region"),i.setAttribute("aria-label","en"===s?"Knowledge base references":"çŸ¥è¯†åº“å¼•ç”¨åˆ—è¡¨"),i.innerHTML=e.references.map((e,t)=>{const a=this._getPersona(e.critic);return`\n        <div class="reference-item" data-ref-index="${t}">\n          <div class="reference-header">\n            <strong class="reference-critic">${a?"en"===s?a.nameEn:a.nameZh:e.critic}</strong>\n            <span class="reference-source">${e.source}</span>\n          </div>\n          <blockquote class="reference-quote" lang="${s}">\n            ${e.quote}\n          </blockquote>\n          ${e.page?`<p class="reference-page">${e.page}</p>`:""}\n        </div>\n      `}).join(""),n.addEventListener("click",t=>{t.stopPropagation();const a="true"===n.getAttribute("aria-expanded");n.setAttribute("aria-expanded",!a),i.classList.toggle("expanded"),n.setAttribute("aria-label","en"===s?`${e.references.length} knowledge base references. Click to ${a?"expand":"collapse"}.`:`${e.references.length}ä¸ªçŸ¥è¯†åº“å¼•ç”¨ã€‚ç‚¹å‡»${a?"å±•å¼€":"æ”¶èµ·"}ã€‚`),console.log(`[DialoguePlayer] Toggled references for ${e.id}: ${a?"collapsed":"expanded"}`)}),a.appendChild(n),a.appendChild(i),console.log(`[DialoguePlayer] Rendered ${e.references.length} KB references for message ${e.id}`),a}_showQuoteModal(e,t){const s=document.documentElement.getAttribute("data-lang")||this.options.lang;let a=document.querySelector(".quote-modal-backdrop");a||(a=document.createElement("div"),a.className="quote-modal-backdrop",a.setAttribute("role","dialog"),a.setAttribute("aria-modal","true"),a.setAttribute("aria-labelledby","quote-modal-title"),document.body.appendChild(a));const n="en"===s?"Close":"å…³é—­",i="en"===s?"Quoted from":"å¼•ç”¨è‡ª",r="en"===s?t.nameEn:t.nameZh;a.innerHTML=`\n      <div class="quote-modal">\n        <div class="quote-modal-header">\n          <h4 id="quote-modal-title" style="color: ${t.color}">\n            ${i} ${r}\n          </h4>\n          <button class="quote-modal-close" aria-label="${n}">âœ•</button>\n        </div>\n        <div class="quote-modal-body">\n          <blockquote>\n            <cite style="color: ${t.color}">${r}</cite>\n            <p>${e.quotedText}</p>\n          </blockquote>\n        </div>\n      </div>\n    `,requestAnimationFrame(()=>{a.classList.add("active")});const o=a.querySelector(".quote-modal-close"),l=a.querySelector(".quote-modal"),d=()=>{a.classList.remove("active"),setTimeout(()=>{a.parentNode&&a.remove()},300)};o.addEventListener("click",d),a.addEventListener("click",e=>{e.target===a&&d()}),l.addEventListener("click",e=>{e.stopPropagation()});const c=e=>{"Escape"===e.key&&(d(),document.removeEventListener("keydown",c))};document.addEventListener("keydown",c),console.log(`[DialoguePlayer] Opened quote modal for ${e.replyTo}`)}_createQuoteBlock(e){const t=document.createElement("blockquote");if(t.className="message-quote",e.replyTo){const s=this.thread.messages.find(t=>t.personaId===e.replyTo);if(s){const a=this._getPersona(s.personaId),n=document.documentElement.getAttribute("data-lang")||this.options.lang;t.innerHTML=`\n          <cite style="color: ${a.color}">\n            ${"en"===n?a.nameEn:a.nameZh}:\n          </cite>\n          <p>${e.quotedText}</p>\n        `,t.style.cursor="pointer",t.setAttribute("title","en"===n?"Click to view original message":"ç‚¹å‡»æŸ¥çœ‹åŸå§‹æ¶ˆæ¯"),t.dataset.replyTo=e.replyTo,t.addEventListener("click",()=>{this._scrollToPersonaMessage(e.replyTo)})}else t.innerHTML=`<p>${e.quotedText}</p>`}else t.innerHTML=`<p>${e.quotedText}</p>`;return t}_scrollToPersonaMessage(e){const t=this.thread.messages.find(t=>t.personaId===e);if(!t)return void console.warn("[DialoguePlayer] No message found for persona:",e);const s=this.messageElements.get(t.id);s?(s.scrollIntoView({behavior:"smooth",block:"center"}),s.classList.add("pulse"),setTimeout(()=>{s.classList.remove("pulse")},3e3),console.log("[DialoguePlayer] Scrolled to message:",t.id)):console.warn("[DialoguePlayer] Message element not found:",t.id)}_initializeControls(){this.controlsContainer.innerHTML="",console.log("[DialoguePlayer] Controls initialized (minimal - no UI)")}_attachControlListeners(){console.log("[DialoguePlayer] Control listeners attached (none - auto-play mode)")}_markFutureMessages(){this.thread.messages.forEach((e,t)=>{if(t>this.currentMessageIndex){const t=this.messageElements.get(e.id);t&&!t.classList.contains("message-hidden")&&(t.classList.add("future"),t.classList.remove("past","current"))}}),console.log(`[DialoguePlayer] Marked ${this.thread.messages.length-this.currentMessageIndex-1} messages as future`)}_scrollToMessage(e){e?(this._isAutoScrolling=!0,e.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"}),setTimeout(()=>{this._isAutoScrolling=!1},600),console.log("[DialoguePlayer] Auto-scrolled to current message (centered)")):console.warn("[DialoguePlayer] Cannot scroll to null message element")}_showErrorState(e){const t=this._sanitizeErrorMessage(e);this.container.innerHTML=`\n      <div class="dialogue-player-error">\n        <div class="error-icon" role="img" aria-label="Error">âš ï¸</div>\n        <h3>Unable to Load Dialogue</h3>\n        <p class="error-message">${t}</p>\n        <button class="error-retry-btn" onclick="window.location.reload();">\n          Retry\n        </button>\n      </div>\n    `,console.error("[DialoguePlayer] Error state displayed:",e)}_showEmptyState(){this.container.innerHTML='\n      <div class="dialogue-player-error">\n        <div class="error-icon" role="img" aria-label="Info">â„¹ï¸</div>\n        <h3>No Dialogue Content</h3>\n        <p class="error-message">This dialogue thread contains no messages yet.</p>\n      </div>\n    ',console.log("[DialoguePlayer] Empty state displayed")}_showLoadingState(){this.container.innerHTML='\n      <div class="dialogue-player-loading">\n        <div class="spinner" role="status" aria-label="Loading"></div>\n        <p>Loading dialogue...</p>\n      </div>\n    ',console.log("[DialoguePlayer] Loading state displayed")}_hideLoadingState(){const e=this.container.querySelector(".dialogue-player-loading");e&&(e.remove(),console.log("[DialoguePlayer] Loading state hidden"))}_sanitizeErrorMessage(e){const t={"No dialogue thread data provided":"Dialogue data is missing. Please refresh the page.","Thread.messages is missing or invalid":"Dialogue format is incorrect. Please contact support.","Invalid dialogue thread provided":"Unable to load dialogue data. Please try again.","Invalid container element provided":"Page rendering error. Please refresh the page."};for(const[s,a]of Object.entries(t))if(e.includes(s))return a;return"Something went wrong while loading the dialogue. Please refresh the page and try again."}_validateThreadData(e){if(!e)throw new Error("[DialoguePlayer] No dialogue thread data provided");if(!e.id)throw new Error("[DialoguePlayer] Thread missing required field: id");if(!e.topic)throw new Error("[DialoguePlayer] Thread missing required field: topic");if(!Array.isArray(e.messages))throw new Error("[DialoguePlayer] Thread.messages must be an array");if(!Array.isArray(e.participants))throw new Error("[DialoguePlayer] Thread.participants must be an array");e.messages.forEach((e,t)=>{if(!e.id)throw new Error(`[DialoguePlayer] Message ${t} missing required field: id`);if(!e.personaId)throw new Error(`[DialoguePlayer] Message ${e.id} missing required field: personaId`);if(!e.text)throw new Error(`[DialoguePlayer] Message ${e.id} missing required field: text`);if("number"!=typeof e.timestamp)throw new Error(`[DialoguePlayer] Message ${e.id} missing or invalid timestamp (must be number)`)}),console.log("[DialoguePlayer] Data validation passed âœ“")}_createMessageElement(e,t){const s=this._getPersona(e.personaId);if(!s)return console.warn(`[DialoguePlayer] Persona not found: ${e.personaId}`),null;const a=document.documentElement.getAttribute("data-lang")||this.options.lang,n=document.createElement("div");if(n.className="dialogue-message",n.dataset.messageId=e.id,n.dataset.personaId=e.personaId,n.dataset.interactionType=e.interactionType,n.dataset.timestamp=e.timestamp,n.setAttribute("role","article"),n.setAttribute("aria-label",`Comment by ${s.nameZh} ${s.nameEn}`),n.innerHTML=`\n      <div class="message-header">\n        <span class="message-author" style="color: ${s.color}">\n          ${"en"===a?s.nameEn:s.nameZh}\n        </span>\n        <span class="interaction-badge ${e.interactionType}">\n          ${this._getInteractionLabel(e.interactionType,a)}\n        </span>\n      </div>\n      <div class="message-content">\n        ${"en"===a?e.textEn:e.textZh}\n      </div>\n    `,e.quotedText&&e.replyTo){const t=this._renderQuoteRef(e),s=n.querySelector(".message-content");s&&t&&s.insertBefore(t,s.firstChild)}if(e.references&&e.references.length>0){console.log(`[DialoguePlayer] _createMessageElement: Rendering ${e.references.length} KB references for ${e.id}`);const t=this._renderKnowledgeReferences(e,s);t&&(n.appendChild(t),console.log(`[DialoguePlayer] _createMessageElement: KB references added for ${e.id}`))}return n}_createThoughtChain(e){const t=document.createElement("div");t.className="thought-chain";const s=document.documentElement.getAttribute("data-lang")||"zh";return(THOUGHT_CHAINS[e]||THOUGHT_CHAINS.default)[s].forEach((e,s)=>{const a=document.createElement("div");a.className="thought-chain-item",a.textContent=e,a.dataset.index=s,t.appendChild(a)}),t}_startThoughtChainCarousel(e,t,s){const a=Array.from(t.querySelectorAll(".thought-chain-item"));if(0===a.length)return;let n=0;this._thoughtChainStates.set(e,{currentIndex:n,items:a}),a[0].classList.add("active");const i=setInterval(()=>{a[n].classList.remove("active"),n=(n+1)%a.length,a[n].classList.add("active"),this._thoughtChainStates.set(e,{currentIndex:n,items:a})},2e3);this._thoughtChainIntervals.set(e,i),console.log(`[DialoguePlayer] Started thought chain for ${e} (persona: ${s})`)}_stopThoughtChainCarousel(e){const t=this._thoughtChainIntervals.get(e);t&&(clearInterval(t),this._thoughtChainIntervals.delete(e),this._thoughtChainStates.delete(e),console.log(`[DialoguePlayer] Stopped thought chain for ${e}`))}destroy(){this._playbackTimeouts&&(this._playbackTimeouts.forEach(e=>clearTimeout(e)),this._playbackTimeouts=[]),this._thoughtChainIntervals&&(this._thoughtChainIntervals.forEach((e,t)=>{clearInterval(e),console.log(`[DialoguePlayer] Cleaned up thought chain interval for ${t}`)}),this._thoughtChainIntervals.clear(),this._thoughtChainStates.clear()),this.container.innerHTML="",this.renderedMessages.clear(),this.messageElements.clear(),console.log("[DialoguePlayer] Destroyed")}}"undefined"!=typeof module&&module.exports&&(module.exports=DialoguePlayer),"undefined"!=typeof window&&(window.DialoguePlayer=DialoguePlayer),console.log("[DialoguePlayer] Class loaded successfully");