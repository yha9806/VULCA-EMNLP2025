!function(){"use strict";window.ArtworkImageCarousel=class{constructor(e,t,i={}){if(!e)throw new Error("[Carousel] Artwork object is required");if(!(t&&t instanceof HTMLElement))throw new Error("[Carousel] Container must be a valid DOM element");if(this.artwork=e,this.container=t,!window.ImageCompat)throw new Error("[Carousel] ImageCompat utility not loaded. Include js/utils/image-compat.js before carousel.");this.images=window.ImageCompat.getArtworkImages(e),0===this.images.length&&console.warn(`[Carousel] No images found for artwork ${e.id}`),this.currentIndex=0,this.loadedImages=new Set,this.highlightedImages=new Set,this.options={autoplay:i.autoplay||!1,autoplayInterval:i.autoplayInterval||5e3,loop:!1!==i.loop,preloadAdjacent:!1!==i.preloadAdjacent,showMetadata:!1!==i.showMetadata,showIndicators:!1!==i.showIndicators,enableKeyboard:!1!==i.enableKeyboard,enableTouch:!1!==i.enableTouch,transition:i.transition||"fade",transitionDuration:i.transitionDuration||300,...i},this.elements={carousel:null,viewport:null,imageContainer:null,prevButton:null,nextButton:null,indicators:null,metadata:null},this._boundKeyHandler=this._handleKeyDown.bind(this),this._boundTouchStart=this._handleTouchStart.bind(this),this._boundTouchMove=this._handleTouchMove.bind(this),this._boundTouchEnd=this._handleTouchEnd.bind(this),this._touchStartX=0,this._touchStartY=0,this._touchCurrentX=0,this._touchCurrentY=0,this._isSwiping=!1,console.log(`[Carousel] Initialized for ${e.id} with ${this.images.length} images`)}render(){console.log(`[Carousel] Rendering carousel for ${this.artwork.id}`),this.container.innerHTML="",this.container.className="artwork-carousel",this.container.innerHTML='\n        <div class="carousel-wrapper">\n          \x3c!-- Main viewport --\x3e\n          <div class="carousel-viewport" role="region" aria-label="Artwork image carousel">\n            <div class="carousel-image-container"></div>\n          </div>\n\n          \x3c!-- Navigation controls (will be populated by _renderControls) --\x3e\n          <div class="carousel-controls">\n            <button class="carousel-btn carousel-btn-prev" aria-label="Previous image">\n              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <polyline points="15 18 9 12 15 6"></polyline>\n              </svg>\n            </button>\n            <button class="carousel-btn carousel-btn-next" aria-label="Next image">\n              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <polyline points="9 18 15 12 9 6"></polyline>\n              </svg>\n            </button>\n          </div>\n\n          \x3c!-- Indicators (dots) --\x3e\n          <div class="carousel-indicators" role="tablist" aria-label="Image selection"></div>\n\n          \x3c!-- Image metadata --\x3e\n          <div class="carousel-metadata"></div>\n        </div>\n      ',this.elements.carousel=this.container.querySelector(".carousel-wrapper"),this.elements.viewport=this.container.querySelector(".carousel-viewport"),this.elements.imageContainer=this.container.querySelector(".carousel-image-container"),this.elements.prevButton=this.container.querySelector(".carousel-btn-prev"),this.elements.nextButton=this.container.querySelector(".carousel-btn-next"),this.elements.indicators=this.container.querySelector(".carousel-indicators"),this.elements.metadata=this.container.querySelector(".carousel-metadata"),this._renderIndicators(),this._renderCurrentImage(),this._renderMetadata(),this._updateNavigationState(),this._attachEventListeners(),console.log(`[Carousel] Render complete, displaying image ${this.currentIndex+1} of ${this.images.length}`)}next(){return this.currentIndex<this.images.length-1?this.goTo(this.currentIndex+1):this.options.loop?this.goTo(0):(console.log("[Carousel] At last image, loop disabled"),!1)}prev(){return this.currentIndex>0?this.goTo(this.currentIndex-1):this.options.loop?this.goTo(this.images.length-1):(console.log("[Carousel] At first image, loop disabled"),!1)}goTo(e){if(e<0||e>=this.images.length)return console.warn(`[Carousel] Invalid index ${e}, must be 0-${this.images.length-1}`),!1;if(e===this.currentIndex)return console.log(`[Carousel] Already at index ${e}`),!1;console.log(`[Carousel] Navigating from ${this.currentIndex} to ${e}`);const t=this.currentIndex;return this.currentIndex=e,this._renderCurrentImage(),this._renderMetadata(),this._updateIndicators(),this._updateNavigationState(),this.options.preloadAdjacent&&this._preloadAdjacentImages(),this._emitEvent("carousel:change",{previousIndex:t,currentIndex:this.currentIndex,image:this.images[this.currentIndex]}),!0}highlightImages(e){this.highlightedImages=new Set(e),this._updateIndicators(),console.log(`[Carousel] Highlighting ${e.length} images:`,e)}clearHighlights(){this.highlightedImages.clear(),this._updateIndicators(),console.log("[Carousel] Cleared all highlights")}destroy(){console.log(`[Carousel] Destroying carousel for ${this.artwork.id}`),this._detachEventListeners(),this.container.innerHTML="",this.container.className="",this.elements={},this.images=[],this.loadedImages.clear(),this.highlightedImages.clear()}_renderCurrentImage(){if(0===this.images.length)return void(this.elements.imageContainer.innerHTML='<div class="carousel-empty">No images available</div>');const e=this.images[this.currentIndex],t=`\n        <div class="carousel-slide ${"slide"===this.options.transition?"slide":"fade"}">\n          <img\n            src="${e.url}"\n            alt="${e.titleEn}"\n            class="carousel-image"\n            data-image-id="${e.id}"\n            loading="eager"\n          />\n          <div class="carousel-loading">\n            <div class="spinner"></div>\n            <p>Loading image...</p>\n          </div>\n        </div>\n      `;this.elements.imageContainer.innerHTML=t;const i=this.elements.imageContainer.querySelector("img"),n=this.elements.imageContainer.querySelector(".carousel-loading");i.addEventListener("load",()=>{n.style.display="none",i.classList.add("loaded"),this.loadedImages.add(e.id),console.log(`[Carousel] Image loaded: ${e.id}`)}),i.addEventListener("error",()=>{n.innerHTML=`\n          <div class="carousel-error">\n            <p>⚠️ Failed to load image</p>\n            <p class="error-detail">${e.titleZh}</p>\n          </div>\n        `,console.error(`[Carousel] Failed to load image: ${e.url}`)})}_renderMetadata(){if(!this.options.showMetadata||0===this.images.length)return void(this.elements.metadata.innerHTML="");const e=this.images[this.currentIndex],t=this._getCategoryLabel(e.category),i=`\n        <div class="carousel-metadata-content">\n          \x3c!-- Category badge --\x3e\n          <span class="category-badge category-${e.category}">${t}</span>\n\n          \x3c!-- Image count indicator --\x3e\n          <span class="image-counter" aria-label="Image ${this.currentIndex+1} of ${this.images.length}">\n            ${this.currentIndex+1} / ${this.images.length}\n          </span>\n\n          \x3c!-- Titles --\x3e\n          <h3 class="image-title" lang="zh">${e.titleZh}</h3>\n          <p class="image-title-en" lang="en">${e.titleEn}</p>\n\n          \x3c!-- Caption (if exists) --\x3e\n          ${e.caption?`<p class="image-caption">${e.caption}</p>`:""}\n        </div>\n      `;this.elements.metadata.innerHTML=i}_renderIndicators(){if(!this.options.showIndicators||this.images.length<=1)return void(this.elements.indicators.innerHTML="");const e=this.images.map((e,t)=>`\n        <button\n          class="carousel-indicator ${t===this.currentIndex?"active":""} ${this.highlightedImages.has(e.id)?"highlighted":""}"\n          role="tab"\n          aria-label="Go to image ${t+1}: ${e.titleEn}"\n          aria-selected="${t===this.currentIndex}"\n          data-index="${t}"\n          data-image-id="${e.id}"\n        ></button>\n      `).join("");this.elements.indicators.innerHTML=e,this.elements.indicators.querySelectorAll(".carousel-indicator").forEach((e,t)=>{e.addEventListener("click",()=>this.goTo(t))})}_updateIndicators(){this.options.showIndicators&&this.elements.indicators.querySelectorAll(".carousel-indicator").forEach((e,t)=>{const i=e.dataset.imageId;e.classList.toggle("active",t===this.currentIndex),e.classList.toggle("highlighted",this.highlightedImages.has(i)),e.setAttribute("aria-selected",t===this.currentIndex)})}_updateNavigationState(){this.options.loop?(this.elements.prevButton.disabled=!1,this.elements.nextButton.disabled=!1):(this.elements.prevButton.disabled=0===this.currentIndex,this.elements.nextButton.disabled=this.currentIndex===this.images.length-1)}_preloadAdjacentImages(){const e=[];this.currentIndex>0?e.push(this.currentIndex-1):this.options.loop&&e.push(this.images.length-1),this.currentIndex<this.images.length-1?e.push(this.currentIndex+1):this.options.loop&&e.push(0),e.forEach(e=>{const t=this.images[e];if(!this.loadedImages.has(t.id)){const e=new Image;e.src=t.url,e.onload=()=>{this.loadedImages.add(t.id),console.log(`[Carousel] Preloaded: ${t.id}`)}}})}_attachEventListeners(){this.elements.prevButton.addEventListener("click",()=>this.prev()),this.elements.nextButton.addEventListener("click",()=>this.next()),this.options.enableKeyboard&&document.addEventListener("keydown",this._boundKeyHandler),this.options.enableTouch&&(this.elements.viewport.addEventListener("touchstart",this._boundTouchStart,{passive:!0}),this.elements.viewport.addEventListener("touchmove",this._boundTouchMove,{passive:!1}),this.elements.viewport.addEventListener("touchend",this._boundTouchEnd,{passive:!0})),this._boundNavigateToHandler=e=>{const{imageIndex:t}=e.detail;"number"==typeof t&&t>=0&&t<this.images.length&&this.goTo(t)},this.container.addEventListener("carousel:navigateTo",this._boundNavigateToHandler)}_detachEventListeners(){document.removeEventListener("keydown",this._boundKeyHandler),this.elements.viewport&&(this.elements.viewport.removeEventListener("touchstart",this._boundTouchStart),this.elements.viewport.removeEventListener("touchmove",this._boundTouchMove),this.elements.viewport.removeEventListener("touchend",this._boundTouchEnd)),this.container&&this._boundNavigateToHandler&&this.container.removeEventListener("carousel:navigateTo",this._boundNavigateToHandler)}_handleKeyDown(e){if(this.container.offsetParent)switch(e.key){case"ArrowRight":case"ArrowDown":e.preventDefault(),this.next();break;case"ArrowLeft":case"ArrowUp":e.preventDefault(),this.prev();break;case"Home":e.preventDefault(),this.goTo(0);break;case"End":e.preventDefault(),this.goTo(this.images.length-1)}}_handleTouchStart(e){this._touchStartX=e.touches[0].clientX,this._touchStartY=e.touches[0].clientY,this._isSwiping=!1}_handleTouchMove(e){if(!this._touchStartX)return;this._touchCurrentX=e.touches[0].clientX,this._touchCurrentY=e.touches[0].clientY;const t=this._touchCurrentX-this._touchStartX,i=this._touchCurrentY-this._touchStartY;Math.abs(t)>Math.abs(i)&&Math.abs(t)>10&&(this._isSwiping=!0,e.preventDefault())}_handleTouchEnd(e){if(!this._isSwiping)return;const t=this._touchCurrentX-this._touchStartX;Math.abs(t)>50&&(t>0?this.prev():this.next()),this._touchStartX=0,this._touchStartY=0,this._touchCurrentX=0,this._touchCurrentY=0,this._isSwiping=!1}_getCategoryLabel(e){return{sketch:"Sketch",process:"Process",installation:"Installation",detail:"Detail",final:"Final",context:"Context"}[e]||e}_emitEvent(e,t){const i=new CustomEvent(e,{detail:t,bubbles:!0});this.container.dispatchEvent(i)}},console.log("[Carousel] ArtworkImageCarousel class registered")}();